// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum TeamRole {
  LEADER
  MEMBER
}

enum UserRole {
  ADMIN
  USER
}

enum SessionStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum Provider {
  CREDENTIAL
  GOOGLE
  GITHUB
  LINKEDIN
}

enum ProjectStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  DISQUALIFIED
  WINNER
  FINALIST
  PARTICIPANT
}

enum HackathonCategory {
  WEB3
  AI
}

enum PrizeType {
  GENERAL
  TRACK
  BOUNTY
  SPONSOR
}

// --- Enum for the Request's status
enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

/**
 * //////////////////////////////////////////////////////
 * User And Session
 * //////////////////////////////////////////////////////
 */
model users {
  id                                String                     @id @default(cuid())
  email                             String                     @unique
  username                          String                     @unique
  walletAddress                     String?                    @unique
  password                          String
  name                              String
  role                              UserRole                   @default(USER)
  image                             String?
  providers                         Provider[]                 @default([]) // ["CREDENTIAL", "GOOGLE", "GITHUB", "LINKEDIN"]
  profession                        String?
  bio                               String?
  location                          String?
  org                               String? // Organization name (school, company, etc.)
  skills                            String[]                   @default([])
  website                           String?
  github                            String?
  linkedin                          String?
  telegram                          String?
  twitter                           String?
  whatsapp                          String?
  otherSocials                      String[]                   @default([])
  isEmailVerified                   Boolean                    @default(false)
  emailVerifiedAt                   DateTime?
  lastLoginAt                       DateTime?
  passwordUpdatedAt                 DateTime?
  twoFactorEnabled                  Boolean                    @default(false)
  twoFactorSecret                   String?
  twoFactorConfirmedAt              DateTime?
  isBanned                          Boolean                    @default(false)
  bannedAt                          DateTime?
  bannedReason                      String?
  sessions                          Session[]
  revokedSessions                   Session[]                  @relation("RevokedSessions")
  failedLogins                      FailedLogin[]
  organizations                     Organization[] // USER can create multiple organizations
  createdAt                         DateTime                   @default(now())
  updatedAt                         DateTime                   @updatedAt
  teamMembers                       TeamMember[]
  projects                          Project[]
  rejectedHackathonCreationRequests HackathonCreationRequest[] @relation("rejectedHackathonCreationRequests")
  approvedHackathonCreationRequests HackathonCreationRequest[] @relation("approvedHackathonCreationRequests")

  @@index([email])
  @@index([username])
  @@map("users")
}

model Session {
  id           String        @id @default(cuid())
  userId       String
  provider     Provider      @default(CREDENTIAL)
  refreshToken String        @unique
  expiresAt    DateTime
  status       SessionStatus @default(ACTIVE)
  revokedAt    DateTime?
  revokedById  String? // userId who revoked the session
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user      users  @relation(fields: [userId], references: [id], onDelete: Cascade)
  revokedBy users? @relation("RevokedSessions", fields: [revokedById], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("sessions")
}

model FailedLogin {
  id         String   @id @default(cuid())
  userId     String? // null if the user doesn't exist
  identifier String // email or username used in attempt
  reason     String? // short message: "wrong-password", "no-user", etc.
  createdAt  DateTime @default(now())

  user users? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([identifier])
  @@index([userId])
  @@index([createdAt])
  @@map("failed_logins")
}

/**
 * //////////////////////////////////////////////////////
 * Organization
 * //////////////////////////////////////////////////////
 */
enum OrganizationType {
  ENTERPRISE
  STARTUP
  DAO
  NON_PROFIT
  EDUCATIONAL_INSTITUTION
  GOVERNMENT_AGENCY
  COMMUNITY_DEVELOPER_GROUP
  BLOCKCHAIN_FOUNDATION
  STUDENT_ORGANIZATION
}

enum OrganizationSize {
  ONE_TO_TEN
  ELEVEN_TO_FIFTY
  FIFTY_ONE_TO_TWO_HUNDRED
  TWO_HUNDRED_ONE_TO_FIVE_HUNDRED
  FIVE_HUNDRED_ONE_TO_ONE_THOUSAND
  ONE_THOUSAND
  COMMUNITY_DRIVEN
}

enum Region {
  NORTH_AMERICA
  SOUTH_AMERICA
  EUROPE
  AFRICA
  ASIA
  MIDDLE_EAST
  OCEANIA
  GLOBAL
}

model Organization {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  displayName String // Usually is a short name for the organization, by default it will be the same as the name unless specified
  logo        String?
  tagline     String?
  description String?

  // Type and Size of the Organization
  type             OrganizationType
  establishedYear  Int
  size             OrganizationSize
  operatingRegions Region[]         @default([])

  // Primary Needed Contacts (email, phone)
  email String
  phone String

  // Location 
  country     String
  city        String
  state       String?
  zipCode     String?
  loc_address String?

  // Primary Needed Socials
  website  String
  linkedin String
  github   String
  twitter  String
  ownerId  String

  // Other optional socials
  discord      String?
  telegram     String?
  medium       String?
  youtube      String?
  facebook     String?
  instagram    String?
  reddit       String?
  warpcast     String?
  otherSocials String[] @default([])

  // Other optional fields
  sector String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner                     users                      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  hackathons                Hackathon[]
  hackathonCreationRequests HackathonCreationRequest[]

  @@index([ownerId])
  @@index([name])
  @@index([slug])
  @@map("organizations")
}

/**
 * //////////////////////////////////////////////////////
 * Hackathon
 * //////////////////////////////////////////////////////
 */

enum HackathonStatus {
  DRAFT
  UPCOMING
  REGISTRATION
  ACTIVE
  JUDGING
  COMPLETED
  CANCELLED
}

enum HackathonType {
  IN_PERSON
  ONLINE
  HYBRID
}

enum HackathonTargetAudience {
  STUDENTS
  PROFESSIONALS
  OTHER
}

enum GeographicScope {
  GLOBAL
  REGIONAL
  LOCAL
}

enum FundingSource {
  SELF_FUNDED
  SPONSORS
  GRANTS
  TBD
}

enum SponsorLevel {
  UNDER_5K
  BETWEEN_5K_AND_25K
  BETWEEN_25K_AND_100K
  ABOVE_100K
}

enum YesNoNotApplicable {
  YES
  NO
  NOT_APPLICABLE
}

enum MarketingHelpDetails {
  SOCIAL_MEDIA_PROMOTION
  EMAIL_CAMPAIGNS
  CONTENT_CREATION
  PRESS_RELEASE_MEDIA_OUTREACH
  INFLUENCER_PARTNERSHIPS
  COMMUNITY_OUTREACH
  SEO_LANDING_PAGE_OPTIMIZATION
}

enum EstimatedReach {
  UNDER_500
  BETWEEN_500_AND_5K
  BETWEEN_5K_AND_50K
  ABOVE_50K
}

enum EventLogisticsDetails {
  REGISTRATION_MANAGEMENT
  TEAM_FORMATION_SUPPORT
  SCHEDULE_PLANNING
  FOOD_CATERING_COORDINATION
  SWAG_MERCHANDISE
  TRAVEL_ACCOMMODATION_COORDINATION
}

// The Hackathon Creation Request (Admin approval queue)
model HackathonCreationRequest {
  id                String            @id @default(cuid())
  hackTitle         String
  hackSlug          String            @unique
  hackId            String?
  hackathon         Hackathon?        @relation(fields: [hackId], references: [id], onDelete: Cascade)
  status            RequestStatus     @default(PENDING)
  organizationId    String
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rejectedAt        DateTime?
  rejectedById      String?
  rejectedBy        users?            @relation("rejectedHackathonCreationRequests", fields: [rejectedById], references: [id], onDelete: Cascade)
  rejectedReason    String?
  approvedAt        DateTime?
  approvedById      String?
  approvedBy        users?            @relation("approvedHackathonCreationRequests", fields: [approvedById], references: [id], onDelete: Cascade)
  hackType          HackathonType
  hackCategory      HackathonCategory
  focus             String
  audience          String
  expectedAttendees Int
  geographicScope   GeographicScope

  // Hackathon Location (required if type is IN_PERSON or HYBRID)
  hackCountry String?
  hackCity    String?
  hackState   String?
  hackZipCode String?
  hackAddress String?

  // Dates
  registrationStart DateTime
  registrationEnd   DateTime
  startDate         DateTime
  endDate           DateTime
  judgingStart      DateTime?
  judgingEnd        DateTime?

  // Prize Pool
  prizePool            Float
  prizeToken           String @default("USD")
  expectedTotalWinners Int
  distributionPlan     String

  // Funding
  fundingSources    FundingSource[]
  confirmedSponsors String[]        @default([])

  // Do you need help finding sponsors? (Yes/No)
  needSponsorsHelp Boolean

  // If yes, what level of sponsorship are you targeting? (< $5K, $5K-$25K, $25K-$100K, $100K+)
  sponsorLevel SponsorLevel?

  // Venue details (required if type is IN_PERSON or HYBRID)
  // Do you have a venue secured? (Yes/No/Not applicable)
  venueSecured YesNoNotApplicable

  // Do you need help securing a venue? (Yes/No/Not applicable)
  needVenueHelp YesNoNotApplicable

  // Do you need technical support during the event? (Yes/No)
  technicalSupport Boolean

  // Do you need help setting up live streaming? (Yes/No/Not applicable)
  liveStreaming YesNoNotApplicable

  // Do you need help with marketing the hackathon? (Yes/No)
  marketingHelp Boolean

  // If yes, select all that apply
  marketingHelpDetails MarketingHelpDetails[] @default([])

  // Do you have an existing community/audience? (Yes/No)
  existingCommunity Boolean

  // If yes, what's your estimated reach? (< 500, 500-5K, 5K-50K, 50K+)
  estimatedReach EstimatedReach

  // What's your target registration goal? (number)
  targetRegistrationGoal Int

  // Do you need help organizing workshops? (Yes/No)
  needWorkshopsHelp    Boolean
  workshopsHelpDetails String  @default("")

  // Do you need technical mentors? (Yes/No)
  needTechnicalMentors Boolean

  // If yes, how many? (number)
  technicalMentorCount Int @default(0)

  // Do you need help creating educational content? (tutorials, documentation) (Yes/No)
  needEducationalContent Boolean

  // Do you need speakers for opening/closing ceremonies? (Yes/No)
  needSpeakers Boolean

  // Do you need help finding judges? (Yes/No)
  needJudges Boolean

  // If yes, how many judges needed? (number)
  judgesCount Int @default(0)

  // Desired judge profiles? (VCs, technical experts, industry leaders, etc.)
  judgesProfiles String[] @default([])

  // Do you need help creating judging criteria? (Yes/No)
  needJudgingCriteria Boolean

  // Do you need a custom evaluation/scoring system? (Yes/No)
  needEvaluationSystem Boolean

  // Do you need help with event logistics? (Yes/No)
  needEventLogistics Boolean

  // If yes, select all that apply:
  eventLogisticsDetails EventLogisticsDetails[] @default([])

  // Do you need volunteer coordinators? (Yes/No)
  needVolunteerCoordinators Boolean

  // Do you need help with Discord/Slack community setup? (Yes/No)
  needCommunitySetup Boolean

  // Do you need on-call support during the event? (Yes/No)
  needOnCallSupport Boolean

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance/Search Indexes
  @@index([status])
  @@index([createdAt])
  @@index([organizationId])
  @@index([rejectedById])
  @@index([approvedById])
  @@map("hackathon_creation_requests")
}

model Hackathon {
  id          String            @id @default(cuid())
  title       String
  slug        String            @unique
  banner      String?
  description String            @default("") @db.Text
  location    String?
  category    HackathonCategory
  type        HackathonType     @default(ONLINE)
  status      HackathonStatus   @default(DRAFT)
  tags        String[]          @default([])
  prizePool   Float             @default(0)
  prizeToken  String            @default("USD")

  // Dates
  registrationStart DateTime
  registrationEnd   DateTime
  startDate         DateTime
  endDate           DateTime
  judgingStart      DateTime?
  judgingEnd        DateTime?

  // Settings
  maxTeamSize      Int     @default(4)
  minTeamSize      Int     @default(1)
  maxParticipants  Int?
  requiresApproval Boolean @default(false)
  isPrivate        Boolean @default(false)

  // Stats (denormalized for performance)
  participantCount Int @default(0)
  projectCount     Int @default(0)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Virtual Relations
  tracks                    Track[]
  projects                  Project[]
  prizes                    Prize[]
  hackathonCreationRequests HackathonCreationRequest[]

  @@index([slug])
  @@index([organizationId])
  @@index([status, isPrivate])
  @@index([startDate, endDate])
  @@map("hackathons")
}

model Track {
  id              String   @id @default(cuid())
  hackathonId     String
  name            String
  description     String   @default("") @db.Text
  judgingCriteria String   @default("")
  order           Int      @default(0)
  prizeAmount     Float    @default(0)
  prizeToken      String   @default("USD")
  winnersCount    Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt @default(now())

  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)

  projects Project[]
  prizes   Prize[]

  @@index([hackathonId])
  @@map("tracks")
}

model Prize {
  id           String    @id @default(cuid())
  hackathonId  String
  trackId      String? // Null for general prizes
  title        String
  description  String    @db.Text
  type         PrizeType @default(GENERAL)
  amount       Float     @default(0)
  currency     String    @default("USD")
  winnersCount Int       @default(1)

  // Relations
  hackathon Hackathon     @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  track     Track?        @relation(fields: [trackId], references: [id], onDelete: SetNull)
  winners   PrizeWinner[]

  @@index([hackathonId])
  @@index([trackId])
  @@map("prizes")
}

model PrizeWinner {
  id        String    @id @default(cuid())
  prizeId   String
  projectId String
  rank      Int       @default(1) // 1st, 2nd, 3rd place
  awardedAt DateTime  @default(now())
  paidAt    DateTime? // null if not paid yet

  prize   Prize   @relation(fields: [prizeId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([prizeId, projectId])
  @@index([prizeId])
  @@index([projectId])
  @@map("prize_winners")
}

model Project {
  id          String  @id @default(cuid())
  hackathonId String
  teamId      String
  creatorId   String
  trackId     String?

  title       String
  tagline     String?
  description String  @db.Text
  logo        String?

  // Submission
  status      ProjectStatus @default(DRAFT)
  submittedAt DateTime?

  // Links
  demoUrl  String?
  videoUrl String?
  repoUrl  String?
  pitchUrl String?

  // Tech Stack
  technologies String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hackathon    Hackathon     @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  team         Team?         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator      users         @relation(fields: [creatorId], references: [id])
  track        Track?        @relation(fields: [trackId], references: [id], onDelete: SetNull)
  prizeWinners PrizeWinner[]

  @@index([hackathonId, status])
  @@index([trackId])
  @@index([creatorId])
  @@index([submittedAt])
  @@map("projects")
}

model Team {
  id          String  @id @default(cuid())
  hackathonId String
  name        String
  tagline     String?
  avatar      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  TeamMember[]
  projects Project[]

  @@index([hackathonId])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())

  team Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}
